<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HIVE-ZERO Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            900: '#111827',
                            800: '#1f2937',
                            700: '#374151',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #cy {
            width: 100%;
            height: 100%;
            background-color: #111827;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-mono h-screen flex flex-col overflow-hidden" x-data="dashboard()">

    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 p-4 flex justify-between items-center shadow-md z-10">
        <div class="flex items-center space-x-3">
            <div class="w-3 h-3 rounded-full animate-pulse"
                 :class="connected ? 'bg-green-500' : 'bg-red-500'"></div>
            <h1 class="text-xl font-bold tracking-wider text-green-400">HIVE-ZERO <span class="text-gray-500 text-sm">v1.1</span></h1>
        </div>
        <div class="flex items-center space-x-4 text-sm text-gray-400">
            <div class="flex items-center space-x-2">
                <span class="w-2 h-2 rounded-full" :class="paused ? 'bg-yellow-500' : 'bg-blue-500'"></span>
                <span x-text="paused ? 'SYSTEM PAUSED' : 'SYSTEM ACTIVE'"></span>
            </div>
            <a href="/docs" target="_blank" class="hover:text-green-400 transition-colors">API Docs &rarr;</a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden">

        <!-- Left Panel: Stats & Controls -->
        <aside class="w-1/4 bg-gray-800 border-r border-gray-700 p-6 flex flex-col space-y-6 overflow-y-auto">

            <!-- Controls -->
            <div class="bg-gray-900 rounded-lg p-4 border border-gray-700">
                <h2 class="text-sm font-semibold text-gray-400 uppercase mb-3">Operator Controls</h2>
                <div class="grid grid-cols-1 gap-2">
                    <button @click="togglePause()"
                            class="w-full py-2 px-4 rounded text-sm font-bold transition-colors"
                            :class="paused ? 'bg-green-600 hover:bg-green-500 text-white' : 'bg-yellow-600 hover:bg-yellow-500 text-white'">
                        <span x-text="paused ? 'â–¶ RESUME OPERATIONS' : 'â¸ PAUSE OPERATIONS'"></span>
                    </button>

                    <button @click="triggerDryRun()"
                            class="w-full py-2 px-4 rounded text-sm font-bold bg-blue-600 hover:bg-blue-500 text-white transition-colors border border-blue-500">
                        ðŸ§ª DRY RUN SIMULATION
                    </button>
                </div>
            </div>

            <!-- Active Experts -->
            <div class="bg-gray-900 rounded-lg p-4 border border-gray-700 flex-1">
                <h2 class="text-sm font-semibold text-gray-400 uppercase mb-3">Active Experts</h2>
                <template x-if="activeExperts.length === 0">
                    <div class="text-gray-600 text-sm italic text-center py-4">No active experts</div>
                </template>
                <ul class="space-y-2">
                    <template x-for="expert in activeExperts" :key="expert">
                        <li class="flex items-center space-x-2 text-sm text-green-300 bg-green-900/20 px-2 py-1.5 rounded border border-green-900/50">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            <span x-text="expert"></span>
                        </li>
                    </template>
                </ul>
            </div>

        </aside>

        <!-- Right Panel: Tabs -->
        <section class="flex-1 bg-gray-900 flex flex-col overflow-hidden relative" x-data="{ tab: 'logs' }">

            <!-- Tab Headers -->
            <div class="flex border-b border-gray-700 bg-gray-800">
                <button @click="tab = 'logs'"
                        class="px-6 py-3 text-sm font-medium transition-colors border-r border-gray-700"
                        :class="tab === 'logs' ? 'bg-gray-900 text-green-400 border-t-2 border-t-green-400' : 'text-gray-400 hover:text-gray-200'">
                    Live Logs
                </button>
                <button @click="tab = 'graph'; loadGraph()"
                        class="px-6 py-3 text-sm font-medium transition-colors border-r border-gray-700"
                        :class="tab === 'graph' ? 'bg-gray-900 text-green-400 border-t-2 border-t-green-400' : 'text-gray-400 hover:text-gray-200'">
                    Network Graph
                </button>
            </div>

            <!-- Logs Tab -->
            <div x-show="tab === 'logs'" class="flex-1 flex flex-col p-6 overflow-hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-300 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                        Live Operations Log
                    </h2>
                    <button @click="logs = []" class="text-xs text-gray-500 hover:text-red-400 transition-colors">Clear Logs</button>
                </div>

                <div class="flex-1 overflow-y-auto space-y-2 font-mono text-sm pb-10 pr-2 scrollbar-hide" id="log-container">
                    <template x-for="(log, index) in logs" :key="index">
                        <div class="p-3 rounded border-l-4 transition-all duration-300 ease-in-out hover:bg-gray-800"
                             :class="{
                                'border-green-500 bg-green-900/10': log.type === 'execution',
                                'border-red-500 bg-red-900/10': log.type === 'alert',
                                'border-blue-500 bg-blue-900/10': log.type === 'info' || !log.type
                             }">
                            <div class="flex justify-between items-start">
                                <span class="font-bold uppercase tracking-wide text-xs opacity-75"
                                      :class="{
                                        'text-green-400': log.type === 'execution',
                                        'text-red-400': log.type === 'alert',
                                        'text-blue-400': log.type === 'info' || !log.type
                                      }" x-text="log.type || 'INFO'"></span>
                                <span class="text-xs text-gray-600" x-text="log.timestamp"></span>
                            </div>
                            <div class="mt-1 text-gray-300 break-all" x-text="log.message || JSON.stringify(log)"></div>

                            <template x-if="log.experts_active">
                                <div class="mt-2 text-xs text-gray-500">
                                    Experts: <span class="text-gray-400" x-text="log.experts_active.join(', ')"></span>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Graph Tab -->
            <div x-show="tab === 'graph'" class="flex-1 relative bg-gray-900">
                <div id="cy" class="absolute inset-0"></div>
                <button @click="loadGraph()" class="absolute top-4 right-4 bg-gray-800 p-2 rounded text-gray-400 hover:text-white z-10 border border-gray-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                </button>
            </div>

        </section>
    </main>

    <script>
        function dashboard() {
            return {
                connected: false,
                paused: false,
                socket: null,
                logs: [],
                activeExperts: [],
                lastGoal: null,
                cy: null,

                init() {
                    this.connect();
                    this.checkStatus();
                },

                async checkStatus() {
                    try {
                        const res = await fetch('/health');
                        const data = await res.json();
                        this.paused = data.paused;
                    } catch (e) { console.error(e); }
                },

                async togglePause() {
                    const endpoint = this.paused ? '/control/resume' : '/control/pause';
                    try {
                        await fetch(endpoint, { method: 'POST' });
                        this.paused = !this.paused;
                    } catch (e) {
                        this.addLog({ type: 'alert', message: 'Failed to toggle pause state' });
                    }
                },

                async triggerDryRun() {
                    this.addLog({ type: 'info', message: 'Triggering Dry Run...' });
                    try {
                        const res = await fetch('/execute', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                logs: [{ src_ip: '127.0.0.1', dst_ip: '127.0.0.1', port: 0, proto: 0 }],
                                top_k: 3,
                                dry_run: true
                            })
                        });
                        const data = await res.json();
                        this.addLog({ type: 'info', message: 'Dry Run Result: ' + JSON.stringify(data) });
                    } catch (e) {
                        this.addLog({ type: 'alert', message: 'Dry Run Failed: ' + e });
                    }
                },

                connect() {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws/monitor`;

                    this.socket = new WebSocket(wsUrl);

                    this.socket.onopen = () => {
                        this.connected = true;
                        this.addLog({ type: 'info', message: 'Connected to HIVE-ZERO Core' });
                    };

                    this.socket.onclose = () => {
                        this.connected = false;
                        this.addLog({ type: 'alert', message: 'Connection lost. Reconnecting in 3s...' });
                        setTimeout(() => this.connect(), 3000);
                    };

                    this.socket.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleMessage(data);
                        } catch (e) {
                            console.error('Error parsing message:', e);
                        }
                    };
                },

                handleMessage(data) {
                    this.addLog(data);

                    if (data.type === 'execution') {
                        this.lastGoal = data.goal;
                        this.activeExperts = data.experts_active || [];
                        // Auto-refresh graph on execution
                        if (this.cy) this.loadGraph();
                    } else if (data.message && data.message.includes('PAUSED')) {
                        this.paused = true;
                    } else if (data.message && data.message.includes('RESUMED')) {
                        this.paused = false;
                    }
                },

                addLog(data) {
                    const timestamp = new Date().toLocaleTimeString();
                    this.logs.push({ ...data, timestamp });

                    if (this.logs.length > 100) this.logs.shift();

                    this.$nextTick(() => {
                        const container = document.getElementById('log-container');
                        if (container) container.scrollTop = container.scrollHeight;
                    });
                },

                async loadGraph() {
                    try {
                        const res = await fetch('/graph/viz');
                        const elements = await res.json();

                        if (!this.cy) {
                            this.cy = cytoscape({
                                container: document.getElementById('cy'),
                                elements: elements,
                                style: [
                                    {
                                        selector: 'node',
                                        style: {
                                            'background-color': '#10B981',
                                            'label': 'data(label)',
                                            'color': '#fff',
                                            'text-valign': 'center',
                                            'text-halign': 'center',
                                            'font-size': '10px'
                                        }
                                    },
                                    {
                                        selector: 'edge',
                                        style: {
                                            'width': 2,
                                            'line-color': '#4B5563',
                                            'target-arrow-color': '#4B5563',
                                            'target-arrow-shape': 'triangle',
                                            'curve-style': 'bezier'
                                        }
                                    }
                                ],
                                layout: { name: 'cose' }
                            });
                        } else {
                            this.cy.json({ elements: elements });
                            this.cy.layout({ name: 'cose' }).run();
                        }
                    } catch (e) {
                        console.error("Graph load failed:", e);
                    }
                }
            }
        }
    </script>
</body>
</html>
